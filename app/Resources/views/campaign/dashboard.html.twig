{% extends 'template.html.twig' %}

{% block title %}{{campaign.name}} Dashboard{% endblock %}

{% block body %}
{% set notStarted = false %}

{% set difference = date(campaign.endDate|date('Y/m/d')).diff(date('now'|date('Y/m/d'))) %}
{% set daysLeft = difference.days %}

{% set difference = date(campaign.startDate|date('Y/m/d')).diff(date(campaign.endDate|date('Y/m/d'))) %}
{% set daysTotal = difference.days %}

{% if date('now'|date('Y/m/d')) > date(campaign.endDate|date('Y/m/d')) %}
{% set daysLeft = daysLeft * -1 %}
{% endif %}
{% if date('now'|date('Y/m/d')) < date(campaign.startDate|date('Y/m/d')) %}
  {% set notStarted = true %}
  {% set difference = date(campaign.startDate|date('Y/m/d')).diff(date('now'|date('Y/m/d'))) %}
  {% set startDays = difference.days %}
{% endif %}
{% if notStarted %}
   {% set percentLeft = 0 %}
{% elseif daysLeft > 0 %}
   {% set percentLeft = (((daysTotal - daysLeft) / daysTotal)*100) | number_format(2, '.', ',') %}
{% else %}
   {% set percentLeft = 100 %}
{%  endif %}


<div class="card card-outline-primary mb-3 text-center">
   <div class="card-block">
       <div class="row">
         <div class="col-sm-12" style="text-align:center;">
           <h4><div id="track"  data-countdown="{{ campaign.endDate|date('Y/m/d') }}"></div><h4>
         </div>
       </div>
    </div>
</div>
<!--/.row -->

<div class="row">
    <div class="col-sm-12">
        <div class="card card-inverse card-primary">
            <div class="card-block pb-0">
              <div class="btn-group float-right">
                  <button type="button" class="btn btn-transparent active dropdown-toggle p-0" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="icon-settings"></i>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right">
                      <a class="dropdown-item" href="#">See all Donations</a>
                  </div>
              </div>
                <h4 class="mb-0"><u>${{ totals.donation_amount|number_format(0, '.', ',') }}</u> in donations</h4>
                <p>{{ (totals.donation_amount / campaign.fundingGoal * 100)|number_format(2, '.', ',')}}% of ${{ campaign.fundingGoal|number_format(0, '.', ',') }} goal received</p>
            </div>
            <div class="chart-wrapper px-3" style="height:70px;">
                <canvas id="card-chart1" class="chart" x height="70"></canvas>
            </div>
        </div>
    </div>
    <!--/.col-->
</div>




<div class="card mb-3">
  <div class="card-block">
  <div class="row">
     <div class="col-sm-5">
         <h4 class="card-title mb-0">New Class Awards</h4>
         <div class="small text-muted">{{ date()|date("D, M d") }}</div>
     </div>
     <!--/.col-->
     <div class="col-sm-7 hidden-sm-down">
         <button type="button" disabled class="btn btn-primary float-right"><i class="icon-cloud-download"></i>
         </button>
         <div class="btn-toolbar float-right" role="toolbar" aria-label="Toolbar with button groups">
             <div class="btn-group mr-3" data-toggle="buttons" aria-label="First group">
                 <label class="btn btn-outline-secondary">
                     <input type="radio" name="options" id="option1">View All
                 </label>
             </div>
         </div>
     </div>
     <!--/.col-->
 </div>
 <br/>
   {% if new_classroom_awards is defined and new_classroom_awards | length > 0 %}
       <table class="table table-responsive table-hover table-outline mb-0 no-footer">
           <thead class="thead-default">
               <tr>
                   <th>Classroom</th>
                   <th>Total Donations</th>
                   <th>Award Level</th>
                  <th>Date Earned</th>
               </tr>
           </thead>
           <tbody>
             {% for classroom in new_classroom_awards %}
                 <tr>
                     <td>

                         <a href="{{ path('classroom_show', { 'campaignUrl':campaign.url, 'id': classroom.id }) }}">
                             <span class="hidden-xs">{{ classroom.grade_name }}
                                 -</span>
                             {{ classroom.teacher_name }}</a>
                     </td>
                     <td>${{ classroom.cumulative_donation_amount|number_format(2, '.', ',') }}
                         <span class="hidden-xs">
                             <small>(<span style="color:#5cb85c;">+{{ classroom.donation_amount|number_format(2, '.', ',') }}</span>)</small>
                         </span>
                     </td>
                     <td>${{ classroom.campaignaward_amount }}
                         -
                         {{ classroom.campaignaward_name }}</td>
                     <td>{{ classroom.donated_at|date("D, M d") }}</td>
                 </tr>
             {% endfor %}
           </tbody>
       </table>
    {% else %}
        <div class="card block" style="font-size:120%;">
            <div style="text-align:center">
                <span class="lead">No classes have received new awards today......YET!</span>
            </div>
        </div>
    {% endif %}
</div>
</div>
<!--/.row -->


    <div class="card mb-3">
      <div class="card-block">
      <div class="row">
         <div class="col-sm-5">
             <h4 class="card-title mb-0">Top 10 Class Rankings</h4>
             <div class="small text-muted">{{ date()|date("D, M d") }}</div>
         </div>
         <!--/.col-->
         <div class="col-sm-7 hidden-sm-down">
             <button type="button" disabled class="btn btn-primary float-right"><i class="icon-cloud-download"></i>
             </button>
             <div class="btn-toolbar float-right" role="toolbar" aria-label="Toolbar with button groups">
                 <div class="btn-group mr-3" data-toggle="buttons" aria-label="First group">
                     <label class="btn btn-outline-secondary">
                         <input type="radio" name="options" id="option1">View All
                     </label>
                 </div>
             </div>
         </div>
         <!--/.col-->
     </div>
     <br/>
       {% if new_classroom_awards | length > 0 %}
           <table class="table table-responsive table-hover table-outline mb-0 no-footer">
               <thead class="thead-default">
                   <tr>
                     <th>Rank</th>
                     <th>Classroom</th>
                     <th>Amount</th>
                   </tr>
               </thead>
               <tbody>
               {% for classroom_ranking in classroom_rankings %}
                   <tr>
                       <td style="text-align:center;vertical-align: middle;">
                           <span class="label label-{% if classroom_ranking.rank == 1 %}success{% elseif classroom_ranking.rank == 2 %}warning{% elseif classroom_ranking.rank == 3 %}primary{% else %}default{% endif %}">{{ classroom_ranking.rank }}</span>
                       </td>
                       <td>  {% if is_granted('ROLE_USER') %}
                           <a href="{{ path('classroom_show', {'campaignUrl':campaign.url, 'id': classroom_ranking.id }) }}">{{ classroom_ranking.grade_name }}
                               -
                               {{ classroom_ranking.teacher_name }}</a>{% else %}{{ classroom_ranking.grade_name }}
                                   -
                                   {{ classroom_ranking.teacher_name }}{% endif %}
                       </td>
                       <td style="text-align:right;">${{ classroom_ranking.donation_amount|number_format(2, '.', ',') }}</td>

                   </tr>
               {% endfor %}
               </tbody>
           </table>
        {% else %}
            <div class="card block" style="font-size:120%;">
                <div style="text-align:center">
                    <span class="lead">No classes have received new awards today......YET!</span>
                </div>
            </div>
        {% endif %}
    </div>
    </div>

  <div class="card mb-3">
   <div class="card-block">
   <div class="row">
      <div class="col-sm-5">
          <h4 class="card-title mb-0">Top 10 Student Rankings</h4>
          <div class="small text-muted">{{ date()|date("D, M d") }}</div>
      </div>
      <!--/.col-->
      <div class="col-sm-7 hidden-sm-down">
          <button type="button" disabled class="btn btn-primary float-right"><i class="icon-cloud-download"></i>
          </button>
          <div class="btn-toolbar float-right" role="toolbar" aria-label="Toolbar with button groups">
              <div class="btn-group mr-3" data-toggle="buttons" aria-label="First group">
                  <label class="btn btn-outline-secondary">
                      <input type="radio" name="options" id="option1">View All
                  </label>
              </div>
          </div>
      </div>
      <!--/.col-->
  </div>
  <br/>
    {% if new_classroom_awards is defined and new_classroom_awards | length > 0 %}
        <table class="table table-responsive table-hover table-outline mb-0 no-footer">
            <thead class="thead-default">
                <tr>
                  <th>Rank</th>
                  <th>Classroom</th>
                  <th>Student</th>
                  <th>Amount</th>
                </tr>
            </thead>
            <tbody>
            {% for student_ranking in student_rankings %}
                <tr>
                    <td style="text-align:center;vertical-align: middle;">
                        <span class="label label-{% if student_ranking.rank == 1 %}success{% elseif student_ranking.rank == 2 %}warning{% elseif student_ranking.rank == 3 %}primary{% else %}default{% endif %}">{{ student_ranking.rank }}</span>
                    </td>
                    <td>
                        <a href="{{ path('classroom_show', {'campaignUrl':campaign.url, 'id': student_ranking.classroom_id }) }}">{{ student_ranking.grade_name }} - {{ student_ranking.teacher_name }}</a>
                    </td>
                    <td>
                        <a href="{{ path('student_show', {'campaignUrl': campaign.url, 'id': student_ranking.id }) }}">{{ student_ranking.student_name }}</a>
                    </td>
                    <td style="text-align:right;">${{ student_ranking.donation_amount|number_format(2, '.', ',') }}</td>

                </tr>
            {% endfor %}
            </tbody>
        </table>
     {% else %}
         <div class="card block" style="font-size:120%;">
             <div style="text-align:center">
                 <span class="lead">No classes have received new awards today......YET!</span>
             </div>
         </div>
     {% endif %}
 </div>
 </div>
<!--/.row -->

{% endblock %}

{% block javascripts %}
    <script>
        $('[data-countdown]').each(function() {
            var $this = $(this),
                finalDate = $(this).data('countdown');
            $this.countdown(finalDate, function(event) {
                $this.html(event.strftime('<span class="label label-info">%D</span> day%!D &nbsp;&nbsp;<span class="label label-info">%H</span> hours &nbsp;&nbsp;<span class="label label-info">%M</span> minutes &nbsp;&nbsp;<span class="label label-info">%S</span> seconds &nbsp;&nbsp;remaining'));
            });
        });


        //convert Hex to RGBA
        function convertHex(hex,opacity){
          hex = hex.replace('#','');
          var r = parseInt(hex.substring(0,2), 16);
          var g = parseInt(hex.substring(2,4), 16);
          var b = parseInt(hex.substring(4,6), 16);

          var result = 'rgba('+r+','+g+','+b+','+opacity/100+')';
          return result;
        }

        //Random Numbers
        function random(min,max) {
          return Math.floor(Math.random()*(max-min+1)+min);
        }

        var elements = 16;
        var labels = [];
        var data = [];

        for (var i = 2000; i <= 2000 + elements; i++) {
          labels.push(i);
          data.push(random(40,100));
        }

        var options = {
          maintainAspectRatio: false,
          legend: {
            display: false
          },
          scales: {
            xAxes: [{
              display: false,
              barPercentage: 0.6,
            }],
            yAxes: [{
              display: false,
            }]
          },

        };
        var data = {
          labels: labels,
          datasets: [
            {
              backgroundColor: 'rgba(255,255,255,.3)',
              borderColor: 'transparent',
              data: data
            },
          ]
        };
        var ctx = $('#card-chart1');
        var cardChart1 = new Chart(ctx, {
          type: 'bar',
          data: data,
          options: options
        });


    </script>
{% endblock %}
